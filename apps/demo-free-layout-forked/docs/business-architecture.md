# 仿真系统实体管理业务架构

## 项目概述

本项目是基于 Flowgram 工作流引擎 fork 的工程，专门用于管理仿真系统中的实体定义，并以工作流引擎的方式编辑实体的行为逻辑（行为树）。

## 核心概念

### 1. 实体 (Entity)
仿真系统中的基本单元，包含属性定义和行为逻辑。

### 2. 行为树 (Behavior Tree)
实体的行为逻辑，以工作流的形式定义实体在仿真环境中的行为模式。

### 3. 模块 (Module)
可复用的属性集合，可以被多个实体引用，实现属性的模块化管理。

### 4. 行为函数 (Behavior Function)
系统提供的原子行为，可以在行为树中调用。

## 数据存储架构

### Store 设计

项目采用 Zustand 状态管理，建立了以下几个核心 Store：

#### 1. 后台数据 Store
- **BehaviorStore**: 存储从后台服务获取的行为函数定义
- **GraphStore**: 存储实体的行为树定义
- **ModuleStore**: 存储模块定义（含编辑缓存功能）
- **EntityListStore**: 存储实体列表

#### 2. 前端编辑 Store
- **CurrentEntityStore**: 当前编辑的实体状态管理
- **CurrentGraphStore**: 当前编辑的行为树状态管理

### 数据流向

```
后台服务 → Store → 编辑器组件 → 用户界面
    ↑                                    ↓
    ← 保存操作 ← 编辑状态管理 ← 用户操作
```

## 实体属性架构

### 属性分类

实体属性分为三个层次：

#### 1. 基础属性 (Meta Properties)
- **id**: 实体唯一标识符
- **name**: 实体显示名称
- **description**: 实体描述信息

#### 2. 扩展属性 (Extended Properties)
- 专属于当前实体的自定义属性
- 直接定义在实体上，不依赖模块
- 可以自由增删改

#### 3. 模块属性 (Module Properties)
- 通过模块引用获得的属性
- 属性 ID 带有模块前缀，格式：`{moduleId}/{attributeId}`
- 实体通过 `bundles` 字段关联模块
- 继承模块的所有属性到实体上

### 属性继承机制

```
实体最终属性 = 基础属性 + 扩展属性 + 所有关联模块的属性
```

## 界面架构

### 页面布局

```
┌─────────────────────────────────────────────────────────┐
│                    顶部导航栏                              │
├─────────────────────────────────┬───────────────────────┤
│                                 │                       │
│            主面板                │       右侧边栏          │
│        (工作流编辑器)             │   (属性编辑面板)        │
│                                 │                       │
│  ┌─────────────────────────┐    │  ┌─────────────────┐  │
│  │      Start 节点         │    │  │   基础属性表单   │  │
│  │   (实体属性展示)         │    │  ├─────────────────┤  │
│  └─────────────────────────┘    │  │  实体扩展属性表  │  │
│                                 │  ├─────────────────┤  │
│  ┌─────────────────────────┐    │  │   模块属性表     │  │
│  │      其他节点           │    │  │  (按模块分组)    │  │
│  │   (行为逻辑节点)         │    │  └─────────────────┘  │
│  └─────────────────────────┘    │                       │
│                                 │                       │
└─────────────────────────────────┴───────────────────────┘
```

### 功能分区

#### 1. 顶部导航栏
- 实体选择器
- 保存/撤销操作
- API 模式切换
- 测试页面入口

#### 2. 主面板 (工作流编辑器)
- **Start 节点**: 展示实体属性和基本信息
- **行为节点**: 定义实体的行为逻辑
- **连接线**: 定义行为执行流程

#### 3. 右侧边栏 (属性编辑面板)
- **基础属性表单**: 编辑实体 meta 属性
- **实体扩展属性表**: 管理实体专有属性
- **模块属性表**: 查看和管理模块属性（按模块分组）

## Start 节点展示逻辑

### 展示内容

Start 节点作为实体的入口节点，需要展示：

1. **实体基础信息**
   - 实体 ID、名称、描述

2. **实体扩展属性**
   - 仅展示实体自有的扩展属性
   - **排除模块属性**（避免重复展示）

3. **关联模块清单**
   - 显示实体关联的模块列表
   - 不详细展示模块内的具体属性

### 过滤规则

在 Start 节点的属性展示中：

```typescript
// 正确的过滤逻辑
const entityExtendedProperties = entity.attributes.filter(attr =>
  !attr.isModuleProperty && // 排除模块属性
  !attr.isEntityProperty   // 排除基础属性（meta）
);

const moduleList = entity.bundles; // 模块清单
```

## 边栏展示逻辑

### 展示维度

边栏按照属性来源进行分类展示，这是正确的设计：

1. **基础属性表单**: 展示和编辑 meta 属性
2. **实体扩展属性表**: 展示和编辑实体专有属性
3. **模块属性表**: 按模块分组展示所有模块属性

### 编辑权限

- **基础属性**: 可编辑
- **扩展属性**: 可编辑（增删改）
- **模块属性**: 只读（通过模块管理修改）

## 数据一致性

### 编辑状态管理

- 使用 `isDirty` 标记跟踪未保存的修改
- 提供保存/撤销功能
- 实时同步编辑状态到界面

### 数据同步

- 实体数据变更时自动同步到工作流编辑器
- 模块变更时自动更新相关实体的属性
- 保持前端状态与后台数据的一致性

## 扩展性设计

### 模块化架构

- 组件按功能模块划分
- Store 按数据类型分离
- 支持独立的功能扩展

### API 抽象

- 统一的 API 服务层
- 支持 Mock 模式和真实 API 切换
- 便于测试和开发

## 开发规范

### 文档优先

- 功能设计前先更新文档
- 保持文档与代码的同步
- 记录重要的设计决策

### 组件设计

- 遵循单一职责原则
- 保持组件的可复用性
- 使用 TypeScript 确保类型安全
