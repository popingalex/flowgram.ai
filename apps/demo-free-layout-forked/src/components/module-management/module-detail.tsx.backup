import React, { useCallback, useMemo, ReactNode } from 'react';

import { nanoid } from 'nanoid';
import { Typography, Input, Form, Tag } from '@douyinfe/semi-ui';
import { Divider } from '@douyinfe/semi-ui';
import { IconSearch } from '@douyinfe/semi-icons';

import { createColumn } from '../ext/universal-table/column-configs';
import { UniversalTable } from '../ext/universal-table';
import { EntityPropertyTypeSelector } from '../ext/type-selector-ext';
import {
  useCurrentModule,
  useCurrentModuleActions,
  useEntityList,
  useModuleStore,
} from '../../stores';
import type { ModuleAttribute } from '../../services/types';
// const { Title } = Typography; // æœªä½¿ç”¨

interface ModuleDetailProps {
  selectedModule: any;
  isDirty: boolean; // ä¿ç•™æ¥å£å…¼å®¹æ€§ï¼Œä½†å†…éƒ¨ä½¿ç”¨CurrentModuleStoreçš„çŠ¶æ€
  isSaving: boolean; // ä¿ç•™æ¥å£å…¼å®¹æ€§ï¼Œä½†å†…éƒ¨ä½¿ç”¨CurrentModuleStoreçš„çŠ¶æ€
  canSave: boolean;
  onSave: () => void;
  onUndo: () => void;
  onDelete: () => void;
  actionButtons?: ReactNode;
  statusInfo?: ReactNode;
}

export const ModuleDetail: React.FC<ModuleDetailProps> = ({
  selectedModule,
  canSave,
  onSave,
  onUndo,
  onDelete,
  actionButtons,
  statusInfo,
}) => {
  // ğŸ”‘ ä½¿ç”¨CurrentModuleStoreçš„æ•°æ®å’ŒçŠ¶æ€
  const { editingModule } = useCurrentModule();
  const { updateProperty, updateAttributeProperty, addAttribute, removeAttribute } =
    useCurrentModuleActions();

  // ğŸ”‘ è·å–å®ä½“åˆ—è¡¨å’Œæ¨¡å—åˆ—è¡¨
  const { entities } = useEntityList();
  const { modules } = useModuleStore();

  // ğŸ”‘ æœç´¢çŠ¶æ€
  const [searchText, setSearchText] = React.useState('');
  const [moduleSearchText, setModuleSearchText] = React.useState('');

  // ğŸ”‘ ä½¿ç”¨CurrentModuleStoreçš„editingModuleä½œä¸ºæ•°æ®æº
  const currentModule = editingModule || selectedModule;

  // ğŸ”§ è°ƒè¯•ï¼šæ‰“å°å½“å‰æ¨¡å—çš„å®Œæ•´æ•°æ®
  console.log('ğŸ”§ å½“å‰æ¨¡å—å®Œæ•´æ•°æ®:', {
    currentModule,
    modules: currentModule?.modules,
    modulesType: typeof currentModule?.modules,
    modulesLength: currentModule?.modules?.length,
    isArray: Array.isArray(currentModule?.modules),
  });

  // ğŸ”‘ è®¡ç®—å…³è”çš„å®ä½“åˆ—è¡¨ï¼ˆé€šè¿‡bundleså­—æ®µï¼‰
  const relatedEntities = useMemo(() => {
    if (!currentModule?.id || !entities) return [];

    return entities.filter((entity) => entity.bundles?.includes(currentModule.id));
  }, [currentModule?.id, entities]);

  // ğŸ”‘ è·å–é€‰ä¸­çš„æ¨¡å—IDsï¼ˆä»moduleså­—æ®µï¼‰
  const selectedModuleIds = useMemo(() => {
    if (!currentModule?.modules) return [];

    // currentModule.modules å¯èƒ½æ˜¯å­—ç¬¦ä¸²æ•°ç»„æˆ–å¯¹è±¡æ•°ç»„
    return currentModule.modules.map((module: any) => {
      if (typeof module === 'string') {
        return module; // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥è¿”å›
      } else {
        return module.id; // å¦‚æœæ˜¯å¯¹è±¡ï¼Œè¿”å›idå­—æ®µ
      }
    });
  }, [currentModule?.modules]);

  // ğŸ”‘ æ„å»ºæ¨¡å—è¡¨æ ¼æ•°æ®ï¼ˆæ’é™¤å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ¨¡å—ï¼‰ï¼Œå·²é€‰ä¸­çš„æ’åœ¨å‰é¢
  const moduleTableData = useMemo(() => {
    if (!modules) return [];

    const filteredModules = modules.filter((module) => module.id !== currentModule?.id);

    // åˆ†ç¦»å·²é€‰ä¸­å’Œæœªé€‰ä¸­çš„æ¨¡å—
    const selectedModules = filteredModules.filter((module) =>
      selectedModuleIds.includes(module.id)
    );
    const unselectedModules = filteredModules.filter(
      (module) => !selectedModuleIds.includes(module.id)
    );

    // å·²é€‰ä¸­çš„æ’åœ¨å‰é¢ï¼Œç„¶åæ˜¯æœªé€‰ä¸­çš„
    return [...selectedModules, ...unselectedModules].map((module) => ({
      ...module,
      key: module._indexId,
    }));
  }, [modules, currentModule?.id, selectedModuleIds]);

  // ğŸ”‘ æ„å»ºæ¨¡å—æ ‘å½¢æ•°æ®ï¼ˆåŒ…å«å±æ€§å±•å¼€ï¼‰
  const filteredModules = useMemo(() => {
    if (!moduleTableData) return [];

    // æ„å»ºåŒ…å«å±æ€§çš„æ ‘å½¢æ•°æ®
    const treeData = moduleTableData.map((module) => {
      const moduleAttributes = module.attributes || [];
      const children = moduleAttributes.map((attr: any) => ({
        ...attr,
        _indexId: `${module._indexId}_attr_${attr._indexId || nanoid()}`,
        parentId: module.id,
        isAttribute: true,
      }));

      return {
        ...module,
        _indexId: module._indexId,
        attributeCount: moduleAttributes.length,
        children: children.length > 0 ? children : undefined,
      };
    });

    // å¦‚æœæ²¡æœ‰æœç´¢æ–‡æœ¬ï¼Œè¿”å›å…¨éƒ¨
    if (!moduleSearchText.trim()) return treeData;

    // æœç´¢è¿‡æ»¤
    const searchLower = moduleSearchText.toLowerCase();
    return treeData.filter((module) => {
      // æ¨¡å—æœ¬èº«åŒ¹é…
      const moduleMatch =
        module.id?.toLowerCase().includes(searchLower) ||
        module.name?.toLowerCase().includes(searchLower);

      // å±æ€§åŒ¹é…
      const attributeMatch = module.children?.some((attr: any) =>
        attr.id?.toLowerCase().includes(searchLower) ||
        attr.name?.toLowerCase().includes(searchLower) ||
        attr.type?.toLowerCase().includes(searchLower)
      );

      return moduleMatch || attributeMatch;
    });
  }, [moduleTableData, moduleSearchText]);

  // ğŸ”‘ è·å–é€‰ä¸­çš„æ¨¡å—keysï¼ˆç”¨äºè¡¨æ ¼é€‰ä¸­çŠ¶æ€ï¼‰
  const selectedModuleKeys = useMemo(() => {
    if (!selectedModuleIds || !moduleTableData) return [];

    const keys = selectedModuleIds
      .map((moduleId: string) => {
        // ä»moduleTableDataä¸­æŸ¥æ‰¾ï¼Œä¸è¦ç”¨filteredModulesï¼ˆå¯èƒ½è¢«æœç´¢è¿‡æ»¤ï¼‰
        const moduleInTable = moduleTableData.find((m) => m.id === moduleId);
        return moduleInTable?._indexId;
      })
      .filter(Boolean);

    console.log('ğŸ”§ é€‰ä¸­çŠ¶æ€è°ƒè¯•:', {
      selectedModuleIds,
      selectedModuleKeys: keys,
      moduleTableDataCount: moduleTableData.length,
      moduleTableDataIds: moduleTableData.map(m => ({ id: m.id, _indexId: m._indexId })),
    });

    return keys;
  }, [selectedModuleIds, moduleTableData]);

  // ğŸ”‘ è¿‡æ»¤åçš„å±æ€§åˆ—è¡¨
  const filteredAttributes = useMemo(() => {
    if (!currentModule?.attributes) {
      console.log('ğŸ” è¿‡æ»¤è°ƒè¯•: æ²¡æœ‰å±æ€§æ•°æ®');
      return [];
    }

    if (!searchText.trim()) {
      console.log('ğŸ” è¿‡æ»¤è°ƒè¯•: æ— æœç´¢æ–‡æœ¬ï¼Œè¿”å›å…¨éƒ¨å±æ€§', currentModule.attributes.length);
      return currentModule.attributes;
    }

    const searchLower = searchText.toLowerCase();
    const filtered = currentModule.attributes.filter(
      (attr: any) =>
        attr.displayId?.toLowerCase().includes(searchLower) ||
        attr.name?.toLowerCase().includes(searchLower)
    );

    console.log('ğŸ” è¿‡æ»¤è°ƒè¯•:', {
      æœç´¢æ–‡æœ¬: searchText,
      åŸå§‹æ•°é‡: currentModule.attributes.length,
      è¿‡æ»¤åæ•°é‡: filtered.length,
      åŸå§‹æ•°æ®: currentModule.attributes,
      è¿‡æ»¤ç»“æœ: filtered,
    });

    return filtered;
  }, [currentModule?.attributes, searchText]);

  // ğŸ”‘ å­—æ®µæ›´æ–° - ç›´æ¥ä½¿ç”¨CurrentModuleStoreçš„updateProperty
  const handleFieldChange = useCallback(
    (field: string, value: any) => {
      console.log('ğŸ” æ›´æ–°æ¨¡å—å­—æ®µ:', field, value);
      updateProperty(field, value);
    },
    [updateProperty]
  );

  // ğŸ”‘ å±æ€§å­—æ®µæ›´æ–°
  const handleAttributeFieldChange = useCallback(
    (attributeIndexId: string, field: string, value: any) => {
      console.log('ğŸ” æ›´æ–°å±æ€§å­—æ®µ:', { attributeIndexId, field, value });
      updateAttributeProperty(attributeIndexId, field, value);
    },
    [updateAttributeProperty]
  );

  // ğŸ”‘ ä¸“é—¨å¤„ç†displayIdçš„æ›´æ–°
  const handleDisplayIdChange = useCallback(
    (attributeIndexId: string, displayId: string) => {
      // æ›´æ–°displayId
      updateAttributeProperty(attributeIndexId, 'displayId', displayId);

      // åŒæ—¶æ›´æ–°å®Œæ•´çš„idï¼ˆæ¨¡å—ID + / + displayIdï¼‰
      if (currentModule?.id) {
        const fullId = displayId ? `${currentModule.id}/${displayId}` : displayId;
        updateAttributeProperty(attributeIndexId, 'id', fullId);
      }
    },
    [updateAttributeProperty, currentModule?.id]
  );

  // ğŸ”‘ æ·»åŠ å±æ€§
  const handleAddAttribute = useCallback(() => {
    const newAttribute: Omit<ModuleAttribute, '_indexId'> = {
      id: '', // ç©ºIDï¼Œç”¨æˆ·éœ€è¦å¡«å†™
      name: '', // ç©ºåç§°ï¼Œç”¨æˆ·éœ€è¦å¡«å†™
      type: 'string',
      desc: '',
      displayId: '', // æ— å‰ç¼€ID
      _status: 'new',
    };
    addAttribute({ ...newAttribute, _indexId: nanoid() });
    console.log('ğŸ” æ·»åŠ æ–°å±æ€§');
  }, [addAttribute]);

  // ğŸ”‘ åˆ é™¤å±æ€§
  const handleDeleteAttribute = useCallback(
    (attributeIndexId: string) => {
      removeAttribute(attributeIndexId);
      console.log('ğŸ” åˆ é™¤å±æ€§:', attributeIndexId);
    },
    [removeAttribute]
  );

  // ğŸ”‘ ç±»å‹å˜æ›´
  const handleTypeChange = useCallback(
    (attributeIndexId: string, typeInfo: any) => {
      console.log('ğŸ” ç±»å‹å˜æ›´:', { attributeIndexId, typeInfo });
      updateAttributeProperty(attributeIndexId, 'type', typeInfo.type);
      if (typeInfo.enumClassId) {
        updateAttributeProperty(attributeIndexId, 'enumClassId', typeInfo.enumClassId);
      } else {
        updateAttributeProperty(attributeIndexId, 'enumClassId', undefined);
      }
    },
    [updateAttributeProperty]
  );

  // ğŸ”‘ æ¨¡å—å…³è”å˜æ›´å¤„ç†
  const handleModuleSelectionChange = useCallback(
    (selectedKeys: string[]) => {
      if (!modules) return;

      // å°†é€‰ä¸­çš„_indexIdè½¬æ¢ä¸ºå®Œæ•´çš„æ¨¡å—å¯¹è±¡
      const selectedModuleObjects = selectedKeys
        .map((key) => {
          const module = modules.find((m) => m._indexId === key);
          if (module) {
            return {
              id: module.id,
              deprecated: module.deprecated || false,
              name: module.name,
              _indexId: module._indexId, // ä¿ç•™_indexIdç”¨äºå‰ç«¯å…³è”
            };
          }
          return null;
        })
        .filter(Boolean);

      console.log('ğŸ”§ æ¨¡å—å…³è”å˜æ›´:', {
        selectedKeys,
        selectedModuleObjects,
        oldModules: currentModule?.modules || [],
      });

      // æ›´æ–°æ¨¡å—çš„moduleså­—æ®µä¸ºå®Œæ•´çš„æ¨¡å—å¯¹è±¡æ•°ç»„
      updateProperty('modules', selectedModuleObjects);
    },
    [modules, currentModule?.modules, updateProperty]
  );

  return (
    <div style={{ height: '100%', padding: '24px', overflow: 'auto' }}>
      {/* åŸºæœ¬ä¿¡æ¯ */}
      <div style={{ display: 'flex', flexDirection: 'column', gap: '16px', marginBottom: '24px' }}>
        <div style={{ display: 'flex', alignItems: 'center' }}>
          <Form.Label text="æ¨¡å—" required width={80} align="right" />
          <Input
            value={currentModule.id || ''}
            onChange={(value) => handleFieldChange('id', value)}
            placeholder="æ¨¡å—IDï¼ˆå¿…å¡«ï¼‰"
            validateStatus={!currentModule.id?.trim() ? 'error' : undefined}
            style={{
              flex: 1,
              marginLeft: '12px',
              fontFamily: 'SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace',
              fontSize: '12px',
            }}
            data-testid="module-id-input"
          />
        </div>

        <div style={{ display: 'flex', alignItems: 'center' }}>
          <Form.Label text="åç§°" width={80} align="right" />
          <Input
            value={currentModule.name || ''}
            onChange={(value) => handleFieldChange('name', value)}
            placeholder="æ¨¡å—åç§°"
            style={{ flex: 1, marginLeft: '12px' }}
            data-testid="module-name-input"
          />
        </div>

        <div style={{ display: 'flex', alignItems: 'center' }}>
          <Form.Label text="æè¿°" width={80} align="right" />
          <Input
            value={currentModule.desc || ''}
            onChange={(value) => handleFieldChange('desc', value)}
            placeholder="æ¨¡å—æè¿°"
            style={{ flex: 1, marginLeft: '12px' }}
            data-testid="module-description-input"
          />
        </div>
      </div>

      {/* æ¨¡å—å±æ€§ */}
      <div style={{ display: 'flex', alignItems: 'flex-start' }}>
        <Form.Label text="æ¨¡å—å±æ€§" width={80} align="right" />
        <div style={{ flex: 1, marginLeft: '12px' }}>
          <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
            {/* æœç´¢æ¡† */}
            <Input
              prefix={<IconSearch />}
              placeholder="æœç´¢å±æ€§IDæˆ–åç§°..."
              value={searchText}
              onChange={setSearchText}
              size="small"
              showClear
              style={{ width: '100%' }}
            />

            {/* å±æ€§è¡¨æ ¼ */}
            <UniversalTable
              dataSource={filteredAttributes}
              searchText=""
              columns={[
                createColumn('id', 'ID', 'displayId', {
                  width: 180,
                  searchable: true,
                  editable: true,
                }),
                createColumn('type', '', 'type', {
                  width: 40,
                  searchable: true,
                  render: (value: any, record: any) => (
                    <EntityPropertyTypeSelector
                      value={{
                        type: record.type,
                        ...(record.enumClassId && { enumClassId: record.enumClassId }),
                      }}
                      onChange={(typeInfo: any) => {
                        handleTypeChange(record._indexId, typeInfo);
                      }}
                    />
                  ),
                }),
                createColumn('value', 'é»˜è®¤å€¼', 'value', {
                  width: 200,
                  searchable: true,
                  editable: true,
                }),
                createColumn('name', 'åç§°', 'name', {
                  width: 150,
                  searchable: true,
                  editable: true,
                }),
              ]}
              rowKey="_indexId"
              editable={true}
              deletable={true}
              addable={true}
              size="small"
              emptyText="æš‚æ— å±æ€§"
              onEdit={(key, field, value) => {
                // å¤„ç†ä¸åŒå­—æ®µçš„ç¼–è¾‘
                if (field === 'displayId') {
                  handleDisplayIdChange(key, value);
                } else {
                  handleAttributeFieldChange(key, field, value);
                }
              }}
              onDelete={(key) => {
                handleDeleteAttribute(key);
              }}
              onAdd={() => {
                handleAddAttribute();
              }}
            />
          </div>
        </div>
      </div>

      {/* å…³è”å®ä½“ï¼ˆåªè¯»æ˜¾ç¤ºï¼‰ */}
      {relatedEntities.length > 0 && (
        <div style={{ display: 'flex', alignItems: 'flex-start' }}>
          <Form.Label text="è¢«ä½¿ç”¨" width={80} align="right" />
          <div style={{ flex: 1, marginLeft: '12px' }}>
            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
              {relatedEntities.map((entity) => (
                <Typography.Text
                  key={entity._indexId}
                  link={{
                    href: `/entities/${entity.id}/`,
                  }}
                  style={{
                    fontSize: '12px',
                    padding: '2px 6px',
                    backgroundColor: 'var(--semi-color-fill-1)',
                    borderRadius: '4px',
                    border: '1px solid var(--semi-color-border)',
                  }}
                  data-testid={`related-entity-${entity.id}`}
                >
                  {entity.id} {entity.name && `(${entity.name})`}
                </Typography.Text>
              ))}
            </div>
            <Typography.Text
              type="secondary"
              size="small"
              style={{ display: 'block', marginTop: '4px' }}
            >
              å…± {relatedEntities.length} ä¸ªå®ä½“ä½¿ç”¨æ­¤æ¨¡å—ï¼Œç‚¹å‡»å¯è·³è½¬
            </Typography.Text>
          </div>
        </div>
      )}
      <Divider />

      {/* åµŒå¥—æ¨¡å—ï¼ˆå¯ç¼–è¾‘ï¼‰ */}
      <div style={{ display: 'flex', alignItems: 'flex-start' }}>
        <Form.Label text="åµŒå¥—æ¨¡å—" width={80} align="right" />
        <div style={{ flex: 1, marginLeft: '12px' }}>
          <div style={{ marginBottom: '12px' }}>
            <Input
              prefix={<IconSearch />}
              placeholder="æœç´¢æ¨¡å—IDã€åç§°..."
              value={moduleSearchText}
              onChange={setModuleSearchText}
              showClear
              style={{ width: '100%' }}
            />
          </div>

          <div
            style={{
              height: '400px',
              overflow: 'auto',
              border: '1px solid var(--semi-color-border)',
              borderRadius: '6px',
            }}
          >
            <UniversalTable
              dataSource={filteredModules}
              searchText={moduleSearchText}
              columns={[
                createColumn('id', 'ID', 'id', {
                  width: 150,
                  searchable: true,
                  render: (value: any, record: any) => {
                    const displayValue = record.displayId || record.id;
                    const isGroupHeader = record.children && record.children.length > 0;

                    if (isGroupHeader) {
                      return (
                        <Typography.Text
                          link={{ href: `/modules/${record.id}` }}
                          style={{
                            fontFamily:
                              'SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace',
                            fontSize: '12px',
                            fontWeight: 600,
                            color: 'var(--semi-color-primary)',
                          }}
                          onClick={(e) => e.stopPropagation()}
                        >
                          {displayValue}
                        </Typography.Text>
                      );
                    } else {
                      return (
                        <Typography.Text
                          style={{
                            fontFamily:
                              'SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace',
                            fontSize: '12px',
                          }}
                        >
                          {displayValue}
                        </Typography.Text>
                      );
                    }
                  },
                }),
                createColumn('name', 'åç§°', 'name', {
                  width: 200,
                  searchable: true,
                  render: (value: any, record: any) => {
                    const isGroupHeader = record.children && record.children.length > 0;

                    if (isGroupHeader) {
                      return (
                        <Typography.Text
                          link={{ href: `/modules/${record.id}` }}
                          style={{
                            fontSize: '13px',
                            fontWeight: 600,
                            color: 'var(--semi-color-primary)',
                          }}
                          onClick={(e) => e.stopPropagation()}
                        >
                          {record.name}
                        </Typography.Text>
                      );
                    } else {
                      return (
                        <Typography.Text style={{ fontSize: '13px' }}>{record.name}</Typography.Text>
                      );
                    }
                  },
                }),
                createColumn('typeOrCount', '', 'type', {
                  searchable: true,
                  render: (value: any, record: any) => {
                    const isGroupHeader = record.children && record.children.length > 0;

                    if (isGroupHeader) {
                      // æ¨¡å—è¡Œï¼šæ˜¾ç¤ºå±æ€§ç»Ÿè®¡
                      return (
                        <Tag size="small" color="cyan">
                          {record.attributeCount || 0}
                        </Tag>
                      );
                    } else {
                      // æ¨¡å—å±æ€§è¡Œï¼šæ˜¾ç¤ºç±»å‹
                      return (
                        <EntityPropertyTypeSelector
                          value={{
                            type: record.type,
                            ...(record.enumClassId && { enumClassId: record.enumClassId }),
                          }}
                          onChange={() => {}} // åªè¯»
                          disabled={true}
                        />
                      );
                    }
                  },
                }),
              ]}
              rowKey="_indexId"
              editable={false}
              showSelection={true}
              selectedKeys={selectedModuleKeys}
              onSelectionChange={handleModuleSelectionChange}
              getCheckboxProps={(record) => ({
                disabled: record.isAttribute, // å±æ€§è¡Œç¦ç”¨å¤é€‰æ¡†
                style: record.isAttribute ? { display: 'none' } : {}, // å±æ€§è¡Œéšè—å¤é€‰æ¡†
              })}
              expandable={true}
              childrenColumnName="children"
              defaultExpandAllRows={false}
              expandRowByClick={true}
              size="small"
              emptyText="æš‚æ— æ¨¡å—"
              showPagination={false}
            />
          </div>
        </div>
      </div>
    </div>
  );
};
