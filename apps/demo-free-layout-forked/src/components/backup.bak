import React, { useState, useMemo, useCallback } from 'react';

import { nanoid } from 'nanoid';
import {
  Table,
  Button,
  Space,
  Input,
  Popconfirm,
  Modal,
  Form,
  Typography,
  Tag,
  Tooltip,
} from '@douyinfe/semi-ui';
import {
  IconPlus,
  IconDelete,
  IconLink,
  IconUnlink,
  IconSave,
  IconRefresh,
  IconArrowRight,
  IconUndo,
  IconBranch,
} from '@douyinfe/semi-icons';

import { EntityPropertyTypeSelector, DataRestrictionButton } from './ext/type-selector-ext';
import { ModuleSelectorTableModal } from './bt/module-selector-table';
import { useModuleStore } from '../stores';
import { useEntityList, useEntityListActions } from '../stores';

const { Text } = Typography;

interface EntityListPageProps {
  onViewWorkflow?: (entityId: string) => void;
}

// é€šç”¨å­—æ®µè¾“å…¥ç»„ä»¶ - æ›¿æ¢æ‰€æœ‰é‡å¤çš„è¾“å…¥ç»„ä»¶
const FieldInput = React.memo(
  ({
    value,
    onChange,
    placeholder,
    readonly = false,
    isIdField = false, // IDå­—æ®µä½¿ç”¨ç­‰å®½å­—ä½“
    required = false, // æ˜¯å¦å¿…å¡«
    isDuplicate = false, // æ˜¯å¦é‡å¤
  }: {
    value: string;
    onChange: (newValue: string) => void;
    placeholder: string;
    readonly?: boolean;
    isIdField?: boolean;
    required?: boolean;
    isDuplicate?: boolean;
  }) => {
    if (readonly) {
      const displayValue = isIdField && value ? value.split('/').pop() : value;
      return (
        <Text
          style={{
            fontFamily: isIdField
              ? 'SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace'
              : undefined,
            fontSize: isIdField ? '12px' : '13px',
          }}
        >
          {displayValue}
        </Text>
      );
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºï¼ˆç”¨äºå¿…å¡«æ ¡éªŒï¼‰
    const isEmpty = !value || value.trim() === '';
    const hasError = (required && isEmpty) || isDuplicate;

    return (
      <Input
        value={value}
        onChange={onChange}
        onClick={(e) => e.stopPropagation()}
        onFocus={(e) => e.stopPropagation()}
        size="small"
        placeholder={placeholder}
        validateStatus={hasError ? 'error' : 'default'}
        style={{
          fontFamily: isIdField
            ? 'SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace'
            : undefined,
          fontSize: isIdField ? '12px' : '13px',
        }}
      />
    );
  }
);
FieldInput.displayName = 'FieldInput';

export const EntityListPage: React.FC<EntityListPageProps> = ({ onViewWorkflow }) => {
  const { entities, loading } = useEntityList();
  const {
    addEntity,
    updateEntity,
    updateEntityField,
    updateEntityAttribute,
    addAttributeToEntity,
    removeAttributeFromEntity,
    deleteEntity,
    removeEntity,
    loadEntities,
    saveEntity,
  } = useEntityListActions();
  const { modules } = useModuleStore();

  const [searchText, setSearchText] = useState('');
  const [showModuleLinkModal, setShowModuleLinkModal] = useState(false);
  const [selectedEntity, setSelectedEntity] = useState<any>(null);

  // ğŸ¯ ç®€åŒ–ï¼šç›´æ¥ä½¿ç”¨å®ä½“æ•°æ®ï¼Œæ— éœ€å·¥ä½œå‰¯æœ¬

  // è½¬æ¢ä¸ºè¡¨æ ¼æ•°æ® - ç®€åŒ–ç‰ˆæœ¬ï¼Œç›´æ¥ä½¿ç”¨å®ä½“æ•°æ®
  const tableData = useMemo(() => {
    console.log('ğŸ”„ é‡æ–°è®¡ç®—è¡¨æ ¼æ•°æ®ï¼Œå®ä½“æ•°é‡:', entities.length);
    const data: any[] = [];

    entities.forEach((entity) => {
      const entityRow: any = {
        key: entity._indexId,
        type: 'entity',
        entity: entity, // ğŸ¯ ç›´æ¥ä½¿ç”¨å®ä½“æ•°æ®
        children: [] as any[],
      };

      // å®ä½“å±æ€§
      entity.attributes?.forEach((attr: any) => {
        entityRow.children.push({
          key: attr._indexId,
          type: 'attribute',
          entity: entity,
          attribute: attr,
          readonly: false,
        });
      });

      // å…³è”æ¨¡å—
      entity.bundles?.forEach((bundleId: string) => {
        const module = modules.find((m) => m._indexId === bundleId);
        if (module) {
          const moduleRow: any = {
            key: module._indexId,
            type: 'module',
            entity: entity,
            module: module,
            children: [] as any[],
          };

          // æ¨¡å—å±æ€§
          module.attributes?.forEach((attr: any) => {
            moduleRow.children.push({
              key: attr._indexId,
              type: 'module-attribute',
              entity: entity,
              module: module,
              attribute: attr,
              readonly: true,
            });
          });

          entityRow.children.push(moduleRow);
        }
      });

      data.push(entityRow);
    });

    return data;
  }, [entities, modules]); // ğŸ¯ ç®€åŒ–ä¾èµ–

  // è¿‡æ»¤æ•°æ®
  const filteredData = useMemo(() => {
    if (!searchText) return tableData;

    return tableData.filter((item) => {
      // ç›´æ¥ä½¿ç”¨å­˜å‚¨çš„å®ä½“æ•°æ®
      const entity = item.entity;
      if (!entity) return false;

      const entityMatch =
        (entity.id || '').toLowerCase().includes(searchText.toLowerCase()) ||
        (entity.name || '').toLowerCase().includes(searchText.toLowerCase());

      const childrenMatch = item.children?.some((child: any) => {
        if (child.type === 'attribute') {
          const attribute = child.attribute;
          return (
            attribute &&
            ((attribute.id || '').toLowerCase().includes(searchText.toLowerCase()) ||
              (attribute.name || '').toLowerCase().includes(searchText.toLowerCase()))
          );
        }
        if (child.type === 'module') {
          const module = child.module;
          return (
            module &&
            ((module.id || '').toLowerCase().includes(searchText.toLowerCase()) ||
              (module.name || '').toLowerCase().includes(searchText.toLowerCase()))
          );
        }
        return false;
      });

      return entityMatch || childrenMatch;
    });
  }, [tableData, searchText]); // ğŸ¯ ç®€åŒ–ä¾èµ–ï¼ŒtableDataå·²ç»åŒ…å«äº†å¿…è¦çš„ä¾èµ–

  // ğŸ¯ å­—æ®µå˜æ›´å¤„ç† - ç›´æ¥æ›´æ–°å®ä½“ï¼Œç®€åŒ–é€»è¾‘
  const handleEntityFieldChange = useCallback(
    (entityIndexId: string, field: string, value: any) => {
      console.log('ğŸ” æ›´æ–°å®ä½“å­—æ®µ:', entityIndexId, field, value);
      updateEntityField(entityIndexId, field, value);
    },
    [updateEntityField]
  );

  const handleAttributeFieldChange = useCallback(
    (entityIndexId: string, attributeId: string, field: string, value: any) => {
      console.log('ğŸ” æ›´æ–°å±æ€§å­—æ®µ:', entityIndexId, attributeId, field, value);
      updateEntityAttribute(entityIndexId, attributeId, field, value);
    },
    [updateEntityAttribute]
  );

  const handleTypeChange = (entityIndexId: string, attributeId: string, typeInfo: any) => {
    handleAttributeFieldChange(entityIndexId, attributeId, 'type', typeInfo.type);
  };

  // ğŸ¯ æ£€æŸ¥å®ä½“æ˜¯å¦æœ‰ä¿®æ”¹ - ç›´æ¥æ£€æŸ¥å®ä½“çŠ¶æ€
  const isEntityDirty = useCallback((entity: any) => {
    const status = entity._status;
    console.log('ğŸ” æ£€æŸ¥å®ä½“çŠ¶æ€:', entity._indexId, 'çŠ¶æ€:', status);
    return status === 'dirty';
  }, []);

  // æ£€æŸ¥å®ä½“æ˜¯å¦å¯ä»¥ä¿å­˜ï¼ˆå¿…å¡«é¡¹éƒ½å·²å¡«å†™ä¸”æ— é‡å¤ï¼‰
  const canSaveEntity = (entity: any): boolean => {
    // æ£€æŸ¥å®ä½“ID
    if (!entity.id || entity.id.trim() === '') {
      return false;
    }

    // æ£€æŸ¥å®ä½“IDæ˜¯å¦ä¸å…¶ä»–å®ä½“é‡å¤
    const otherEntities = entities.filter((e) => e._indexId !== entity._indexId);
    if (otherEntities.some((e) => e.id === entity.id)) {
      return false;
    }

    // æ£€æŸ¥æ‰€æœ‰å±æ€§çš„ID
    if (entity.attributes && entity.attributes.length > 0) {
      const attributeIds = new Set();
      for (const attr of entity.attributes) {
        // æ£€æŸ¥å±æ€§IDæ˜¯å¦ä¸ºç©º
        if (!attr.id || attr.id.trim() === '') {
          return false;
        }
        // æ£€æŸ¥å±æ€§IDæ˜¯å¦é‡å¤
        if (attributeIds.has(attr.id)) {
          return false;
        }
        attributeIds.add(attr.id);
      }
    }

    return true;
  };

  // æ£€æŸ¥å­—æ®µæ˜¯å¦é‡å¤
  const checkFieldDuplication = useCallback(
    (
      entityIndexId: string,
      field: 'id' | 'attribute-id',
      value: string,
      attributeIndexId?: string
    ): boolean => {
      if (!value || value.trim() === '') return false;

      if (field === 'id') {
        // æ£€æŸ¥å®ä½“IDé‡å¤
        return entities.some((e) => e._indexId !== entityIndexId && e.id === value);
      } else if (field === 'attribute-id' && attributeIndexId) {
        // æ£€æŸ¥å±æ€§IDé‡å¤ï¼ˆåœ¨åŒä¸€å®ä½“å†…ï¼‰
        const entity = entities.find((e) => e._indexId === entityIndexId);
        if (!entity) return false;

        return (
          entity.attributes?.some(
            (attr) => attr._indexId !== attributeIndexId && attr.id === value
          ) || false
        );
      }

      return false;
    },
    [entities]
  );

  // è·å–ä¿å­˜é”™è¯¯æç¤º
  const getSaveErrorMessage = (entity: any): string => {
    if (!entity.id || entity.id.trim() === '') {
      return 'è¯·å¡«å†™å®ä½“ID';
    }

    // æ£€æŸ¥å®ä½“IDæ˜¯å¦ä¸å…¶ä»–å®ä½“é‡å¤
    const otherEntities = entities.filter((e) => e._indexId !== entity._indexId);
    if (otherEntities.some((e) => e.id === entity.id)) {
      return `å®ä½“ID "${entity.id}" å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨ä¸åŒçš„ID`;
    }

    if (entity.attributes && entity.attributes.length > 0) {
      const attributeIds = new Set();
      for (const attr of entity.attributes) {
        if (!attr.id || attr.id.trim() === '') {
          return 'è¯·å¡«å†™æ‰€æœ‰å±æ€§ID';
        }
        if (attributeIds.has(attr.id)) {
          return `å±æ€§ID "${attr.id}" é‡å¤ï¼Œè¯·ä½¿ç”¨ä¸åŒçš„ID`;
        }
        attributeIds.add(attr.id);
      }
    }

    return 'ä¿å­˜å®ä½“ä¿®æ”¹';
  };

  // è¡¨æ ¼åˆ—å®šä¹‰
  const columns = [
    // ç¬¬ä¸€åˆ—ï¼šå±•å¼€æŒ‰é’® 40px
    {
      key: 'expand',
      width: 20,
      render: (_: any, record: any, index: number, { expandIcon }: any) => expandIcon,
    },
    // ç¬¬äºŒåˆ—ï¼šé“¾æ¥æŒ‰é’®&è¡Œä¸ºæ ‘è·³è½¬æŒ‰é’® 60px
    {
      key: 'navigation',
      width: 60,
      render: (_: any, record: any) => {
        if (record.type === 'entity') {
          const entity = record.entity;
          return entity ? (
            <Space spacing={4}>
              <Tooltip content="ç¼–è¾‘å·¥ä½œæµ">
                <Button
                  size="small"
                  onClick={(e) => {
                    e.stopPropagation();
                    // åœ¨æ–°çª—å£æ‰“å¼€å·¥ä½œæµç¼–è¾‘é¡µé¢ï¼Œä½¿ç”¨hashæ ¼å¼ç¡®ä¿å…¼å®¹æ€§
                    window.open(`/#entity-workflow/${entity.id}`, '_blank');
                  }}
                  icon={<IconBranch />}
                />
              </Tooltip>
              <Tooltip content="å…³è”æ¨¡å—">
                <Button
                  size="small"
                  onClick={(e) => {
                    e.stopPropagation();
                    handleLinkModule(entity);
                  }}
                  icon={<IconLink />}
                />
              </Tooltip>
            </Space>
          ) : null;
        }
        return null;
      },
    },
    // ç¬¬ä¸‰åˆ—ï¼šæ ‡ç­¾ 60px
    {
      key: 'type',
      width: 60,
      render: (_: any, record: any) => {
        if (record.type === 'entity') {
          const isNew = record.entity?._status === 'new';
          return (
            <Tag
              color="blue"
              style={
                isNew
                  ? {
                      boxShadow: '0 0 8px rgba(59, 130, 246, 0.6)',
                      animation: 'pulse 2s infinite',
                    }
                  : {}
              }
            >
              å®ä½“
            </Tag>
          );
        }
        if (record.type === 'attribute') {
          const isNew = record.attribute?._status === 'new';
          return (
            <Tag
              color="green"
              style={
                isNew
                  ? {
                      boxShadow: '0 0 8px rgba(34, 197, 94, 0.6)',
                      animation: 'pulse 2s infinite',
                    }
                  : {}
              }
            >
              å±æ€§
            </Tag>
          );
        }
        if (record.type === 'module') return <Tag color="orange">æ¨¡å—</Tag>;
        if (record.type === 'module-attribute') return <Tag color="grey">å±æ€§</Tag>;
        return <Tag>{record.type}</Tag>;
      },
    },
    // ç¬¬å››åˆ—ï¼šID 120px
    {
      title: 'ID',
      key: 'id',
      width: 160,
      render: (_: any, record: any) => {
        if (record.type === 'entity') {
          const displayEntity = getEntityWorkingCopy(record.entity);
          return (
            <FieldInput
              key={`entity-id-${record.entity._indexId}`}
              value={displayEntity.id}
              onChange={(newValue) =>
                handleEntityFieldChange(record.entity._indexId, 'id', newValue)
              }
              placeholder="å®ä½“IDï¼ˆå¿…å¡«ï¼‰"
              isIdField={true}
              required={true}
              isDuplicate={checkFieldDuplication(record.entity._indexId, 'id', displayEntity.id)}
            />
          );
        } else if (record.type === 'attribute') {
          return (
            <FieldInput
              key={`attr-id-${record.attribute._indexId}`}
              value={record.attribute.id}
              onChange={(newValue) =>
                handleAttributeFieldChange(
                  record.entity._indexId,
                  record.attribute._indexId,
                  'id',
                  newValue
                )
              }
              placeholder="å±æ€§IDï¼ˆå¿…å¡«ï¼‰"
              isIdField={true}
              required={true}
              isDuplicate={checkFieldDuplication(
                record.entity._indexId,
                'attribute-id',
                record.attribute.id,
                record.attribute._indexId
              )}
            />
          );
        } else if (record.type === 'module-attribute') {
          return (
            <FieldInput
              key={`mod-attr-id-${record.attribute._indexId}`}
              value={record.attribute.id}
              onChange={() => {}} // åªè¯»ï¼Œä¸å¤„ç†å˜æ›´
              placeholder="å±æ€§ID"
              isIdField={true}
              readonly={true}
            />
          );
        } else if (record.type === 'module') {
          return (
            <Text
              style={{
                fontFamily: 'SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace',
                fontSize: '12px',
              }}
            >
              {record.module?.id}
            </Text>
          );
        }
        return null;
      },
    },
    // ç¬¬äº”åˆ—ï¼šName 160px
    {
      title: 'åç§°',
      key: 'name',
      width: 200,
      render: (_: any, record: any) => {
        if (record.type === 'entity') {
          const displayEntity = getEntityWorkingCopy(record.entity);
          return (
            <FieldInput
              key={`entity-name-${record.entity._indexId}`}
              value={displayEntity.name}
              onChange={(newValue) =>
                handleEntityFieldChange(record.entity._indexId, 'name', newValue)
              }
              placeholder="å®ä½“åç§°"
            />
          );
        } else if (record.type === 'attribute') {
          return (
            <FieldInput
              key={`attr-name-${record.attribute._indexId}`}
              value={record.attribute.name}
              onChange={(newValue) =>
                handleAttributeFieldChange(
                  record.entity._indexId,
                  record.attribute._indexId,
                  'name',
                  newValue
                )
              }
              placeholder="å±æ€§åç§°"
              readonly={record.readonly}
            />
          );
        } else if (record.type === 'module-attribute') {
          return (
            <FieldInput
              key={`mod-attr-name-${record.attribute._indexId}`}
              value={record.attribute.name}
              onChange={() => {}} // åªè¯»ï¼Œä¸å¤„ç†å˜æ›´
              placeholder="å±æ€§åç§°"
              readonly={record.readonly}
            />
          );
        } else if (record.type === 'module') {
          return <Text style={{ fontSize: '13px' }}>{record.module?.name}</Text>;
        }
        return null;
      },
    },
    // ç¬¬å…­åˆ—ï¼šæ§ä»¶é›†åˆ 80px
    {
      title: () => (
        <Button size="small" icon={<IconPlus />} type="primary" onClick={handleAddEntity}>
          æ·»åŠ å®ä½“
        </Button>
      ),
      key: 'actions',
      width: 100,
      render: (_: any, record: any) => (
        <div
          style={{
            display: 'flex',
            gap: '2px',
            justifyContent: 'flex-start',
            alignItems: 'center',
            // minWidth: '60px',
            // flexWrap: 'wrap',
          }}
          onClick={(e) => e.stopPropagation()}
        >
          {/* ç±»å‹é€‰æ‹©å™¨å’Œæ•°æ®é™åˆ¶æŒ‰é’® - åªåœ¨å±æ€§è¡Œæ˜¾ç¤º */}
          {(record.type === 'attribute' || record.type === 'module-attribute') &&
            record.attribute &&
            (() => {
              if (record.type === 'attribute') {
                const displayAttribute = record.attribute;
                return (
                  <>
                    <Tooltip content="é€‰æ‹©å±æ€§ç±»å‹">
                      <EntityPropertyTypeSelector
                        value={{ type: displayAttribute.type, enum: displayAttribute.enum }}
                        onChange={(typeInfo) =>
                          handleTypeChange(
                            record.entity._indexId,
                            record.attribute._indexId,
                            typeInfo
                          )
                        }
                        disabled={record.readonly}
                      />
                    </Tooltip>
                    <DataRestrictionButton
                      value={{ type: displayAttribute.type, enum: displayAttribute.enum }}
                      onClick={() => {
                        // TODO: æ‰“å¼€æ•°æ®é™åˆ¶ç¼–è¾‘å¼¹çª—
                        console.log('ç¼–è¾‘æ•°æ®é™åˆ¶:', displayAttribute);
                      }}
                      disabled={record.readonly}
                    />
                  </>
                );
              } else {
                return (
                  <>
                    <Tooltip content="å±æ€§ç±»å‹ï¼ˆåªè¯»ï¼‰">
                      <EntityPropertyTypeSelector
                        value={{ type: record.attribute.type, enum: record.attribute.enum }}
                        onChange={(typeInfo) =>
                          handleTypeChange(
                            record.entity._indexId,
                            record.attribute._indexId,
                            typeInfo
                          )
                        }
                        disabled={record.readonly}
                      />
                    </Tooltip>
                    <DataRestrictionButton
                      value={{ type: record.attribute.type, enum: record.attribute.enum }}
                      onClick={() => {
                        // æ¨¡å—å±æ€§ä¸å…è®¸ç¼–è¾‘æ•°æ®é™åˆ¶
                        console.log('æ¨¡å—å±æ€§ä¸å…è®¸ç¼–è¾‘æ•°æ®é™åˆ¶');
                      }}
                      disabled={true}
                    />
                  </>
                );
              }
            })()}

          {/* å®ä½“æ“ä½œæŒ‰é’® */}
          {record.type === 'entity' &&
            record.entity &&
            (() => {
              const entity = getEntityWorkingCopy(record.entity); // ä½¿ç”¨æœ€æ–°çš„ç¼–è¾‘æ•°æ®
              const entityIsDirty = isEntityDirty(record.entity._indexId);
              const canSave = canSaveEntity(entity);

              // è°ƒè¯•ï¼šä¿å­˜æŒ‰é’®çŠ¶æ€
              if (!entityIsDirty || !canSave) {
                console.log('ğŸ” ä¿å­˜æŒ‰é’®ç¦ç”¨åŸå› :', {
                  entityId: record.entity._indexId,
                  isDirty: entityIsDirty,
                  canSave: canSave,
                  errorMessage: getSaveErrorMessage(entity),
                });
              }

              return (
                <>
                  <Tooltip content={getSaveErrorMessage(entity)}>
                    <Popconfirm
                      title="ç¡®å®šä¿å­˜å®ä½“ä¿®æ”¹å—ï¼Ÿ"
                      content="ä¿å­˜åå°†æ›´æ–°åˆ°åå°æ•°æ®"
                      onConfirm={async (e) => {
                        e?.stopPropagation?.();
                        try {
                          const editingId = entityEditingIds[record.entity._indexId];
                          if (editingId) {
                            await saveWorkingCopy(editingId);
                            console.log('âœ… å®ä½“ä¿å­˜æˆåŠŸ');
                          }
                        } catch (error) {
                          console.error('âŒ å®ä½“ä¿å­˜å¤±è´¥:', error);
                        }
                      }}
                    >
                      <Button
                        size="small"
                        type="primary"
                        onClick={(e) => e.stopPropagation()}
                        icon={<IconSave />}
                        disabled={!entityIsDirty || !canSave}
                        loading={entity._editing?.isSaving === true}
                      />
                    </Popconfirm>
                  </Tooltip>
                  {entity._status !== 'new' ? (
                    <Tooltip content="æ’¤é”€ä¿®æ”¹">
                      <Button
                        size="small"
                        onClick={(e) => {
                          e.stopPropagation();
                          const editingId = entityEditingIds[record.entity._indexId];
                          if (editingId) {
                            resetWorkingCopy(editingId);
                          }
                        }}
                        icon={<IconUndo />}
                        disabled={!entityIsDirty}
                      />
                    </Tooltip>
                  ) : (
                    <Button size="small" disabled style={{ opacity: 0.3 }} />
                  )}
                  <Tooltip content="æ·»åŠ å±æ€§">
                    <Button
                      size="small"
                      onClick={(e) => {
                        e.stopPropagation();
                        handleAddAttribute(record.entity._indexId);
                      }}
                      icon={<IconPlus />}
                    />
                  </Tooltip>
                  <Tooltip content="åˆ é™¤å®ä½“">
                    <Popconfirm
                      title={
                        entity._status === 'new'
                          ? 'ç¡®å®šåˆ é™¤è¿™ä¸ªæ–°å¢å®ä½“å—ï¼Ÿ'
                          : 'ç¡®å®šåˆ é™¤è¿™ä¸ªå®ä½“å—ï¼Ÿåˆ é™¤åå°†ä»åå°æ•°æ®ä¸­ç§»é™¤ã€‚'
                      }
                      onConfirm={async (e) => {
                        e?.stopPropagation?.();
                        await handleDeleteEntity(entity);
                      }}
                    >
                      <Button
                        size="small"
                        type="danger"
                        icon={<IconDelete />}
                        onClick={(e) => e.stopPropagation()}
                      />
                    </Popconfirm>
                  </Tooltip>
                </>
              );
            })()}

          {/* å±æ€§åˆ é™¤æŒ‰é’® */}
          {record.type === 'attribute' && record.entity && record.attribute && (
            <Tooltip content="åˆ é™¤å±æ€§">
              <Popconfirm
                title="ç¡®å®šåˆ é™¤è¿™ä¸ªå±æ€§å—ï¼Ÿ"
                onConfirm={(e) => {
                  e?.stopPropagation?.();
                  handleDeleteAttribute(record.entity, record.attribute);
                }}
              >
                <Button
                  size="small"
                  type="danger"
                  icon={<IconDelete />}
                  onClick={(e) => e.stopPropagation()}
                />
              </Popconfirm>
            </Tooltip>
          )}

          {/* æ¨¡å—è§£ç»‘æŒ‰é’® */}
          {record.type === 'module' && record.entity && record.module && (
            <Tooltip content="è§£ç»‘æ¨¡å—">
              <Popconfirm
                title="ç¡®å®šç§»é™¤è¿™ä¸ªæ¨¡å—å—ï¼Ÿ"
                onConfirm={(e) => {
                  e?.stopPropagation?.();
                  handleUnlinkModule(record.entity, record.module);
                }}
              >
                <Button
                  size="small"
                  type="danger"
                  icon={<IconDelete />}
                  onClick={(e) => e.stopPropagation()}
                />
              </Popconfirm>
            </Tooltip>
          )}
        </div>
      ),
    },
  ];

  // äº‹ä»¶å¤„ç†
  const handleViewWorkflow = (entity: any) => {
    if (onViewWorkflow) {
      onViewWorkflow(entity.id);
    }
  };

  const handleSaveEntityChanges = (entity: any) => {
    // å®é™…ä¸Šæ•°æ®å·²ç»å®æ—¶ä¿å­˜åˆ°storeäº†ï¼Œè¿™é‡Œå¯ä»¥æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
    console.log('ä¿å­˜å®ä½“:', entity);
    // TODO: å¯ä»¥è°ƒç”¨åå°APIä¿å­˜
  };

  const handleResetEntityChanges = (entity: any) => {
    // é‡æ–°åŠ è½½å®ä½“æ•°æ®ï¼Œæ’¤é”€æœ¬åœ°ä¿®æ”¹
    console.log('æ’¤é”€å®ä½“ä¿®æ”¹:', entity);
    // TODO: é‡æ–°ä»åå°åŠ è½½æ•°æ®
  };

  const handleDeleteEntity = async (entity: any) => {
    try {
      console.log('ğŸ—‘ï¸ å¼€å§‹åˆ é™¤å®ä½“:', entity.id);

      // å¦‚æœæ˜¯æ–°å¢çŠ¶æ€çš„å®ä½“ï¼Œåªéœ€è¦ä»æœ¬åœ°çŠ¶æ€åˆ é™¤
      if (entity._status === 'new') {
        console.log('ğŸ—‘ï¸ åˆ é™¤æ–°å¢å®ä½“ï¼ˆä»…æœ¬åœ°ï¼‰:', entity.id);
        deleteEntity(entity._indexId);
        return;
      }

      // å·²ä¿å­˜çš„å®ä½“éœ€è¦è°ƒç”¨åå°APIåˆ é™¤
      console.log('ğŸ—‘ï¸ åˆ é™¤å·²ä¿å­˜å®ä½“ï¼ˆè°ƒç”¨APIï¼‰:', entity.id);
      await removeEntity(entity.id); // ä½¿ç”¨ä¸šåŠ¡IDè°ƒç”¨API
      console.log('âœ… å®ä½“åˆ é™¤æˆåŠŸ:', entity.id);
    } catch (error) {
      console.error('âŒ å®ä½“åˆ é™¤å¤±è´¥:', error);
    }
  };

  const handleDeleteAttribute = (entity: any, attribute: any) => {
    const editingId = entityEditingIds[entity._indexId];
    if (editingId) {
      removeAttributeFromWorkingCopy(editingId, attribute._indexId);
    }
  };

  const handleUnlinkModule = (entity: any, module: any) => {
    const updatedEntity = { ...entity };
    updatedEntity.bundles = updatedEntity.bundles?.filter(
      (bundleId: string) => bundleId !== module._indexId
    );
    updateEntity(entity._indexId, updatedEntity);
  };

  const handleLinkModule = (entity: any) => {
    setSelectedEntity(entity);
    setShowModuleLinkModal(true);
  };

  const handleAddEntity = () => {
    const newEntity = {
      _indexId: nanoid(), // ä½¿ç”¨nanoidä½œä¸ºç¨³å®šçš„React key
      id: '', // ä¸šåŠ¡IDç”±ç”¨æˆ·å¡«å†™ï¼ˆå¿…å¡«ï¼‰
      name: '', // åç§°å¯ä»¥ä¸ºç©º
      attributes: [],
      bundles: [],
      deprecated: false,
      _status: 'new' as const, // æ ‡è®°ä¸ºæ–°å¢çŠ¶æ€
    };

    addEntity(newEntity);
    // ğŸ¯ è‡ªåŠ¨å¼€å§‹ç¼–è¾‘æ–°æ·»åŠ çš„å®ä½“
    const editingId = startEditing(newEntity._indexId);
    setEntityEditingIds((prev) => ({
      ...prev,
      [newEntity._indexId]: editingId,
    }));
    console.log('âœ… æ·»åŠ æ–°å®ä½“å¹¶å¼€å§‹ç¼–è¾‘:', newEntity._indexId, 'ç¼–è¾‘ID:', editingId);
  };

  const handleAddAttribute = (entityIndexId: string) => {
    const editingId = entityEditingIds[entityIndexId];
    if (editingId) {
      addAttributeToWorkingCopy(editingId);
      console.log('âœ… ä¸ºå®ä½“æ·»åŠ å±æ€§:', entityIndexId);
    }
  };

  const handleSaveModuleLink = (selectedModuleIds: string[]) => {
    if (selectedEntity) {
      const updatedEntity = { ...selectedEntity };
      updatedEntity.bundles = selectedModuleIds;
      updateEntity(selectedEntity._indexId, updatedEntity);
    }
    setShowModuleLinkModal(false);
    setSelectedEntity(null);
  };

  return (
    <div style={{ padding: '24px' }}>
      <div style={{ marginBottom: '16px', display: 'flex', gap: '12px' }}>
        <Input
          placeholder="æœç´¢å®ä½“ã€å±æ€§..."
          value={searchText}
          onChange={setSearchText}
          style={{ width: 300 }}
        />
        <Button
          icon={<IconRefresh />}
          onClick={async () => {
            console.log('ğŸ”„ åˆ·æ–°æ•°æ®');
            await loadEntities();
            console.log('ğŸ”„ æ•°æ®å·²åˆ·æ–°');
          }}
          loading={loading}
        >
          åˆ·æ–°
        </Button>
      </div>

      <Table
        columns={columns}
        dataSource={filteredData}
        loading={loading}
        pagination={false}
        childrenRecordName="children"
        expandIcon={false}
        expandRowByClick={true}
        hideExpandedColumn={true}
        indentSize={0}
        size="small"
        style={{ tableLayout: 'fixed' }}
        className="entity-list-table"
        scroll={{ y: 'calc(100vh - 200px)' }}
        rowKey="key"
        onRow={useCallback((record: any, index?: number) => {
          // ä¸ºæ–°å¢çŠ¶æ€çš„è¡Œæ·»åŠ classNameï¼Œé¿å…æ¯æ¬¡æ¸²æŸ“åˆ›å»ºæ–°å¯¹è±¡
          if (record.type === 'entity' && record.entity?._status === 'new') {
            return { className: 'entity-row-new' };
          }
          if (
            (record.type === 'attribute' || record.type === 'module-attribute') &&
            record.attribute?._status === 'new'
          ) {
            return { className: 'attribute-row-new' };
          }
          return {};
        }, [])}
      />

      <style>
        {`
          .entity-list-table .semi-table-tbody > .semi-table-row > .semi-table-row-cell {
            padding-right: 12px;
            padding-left: 12px;
          }

          /* æ–°å¢å®ä½“è¡Œçš„å·¦è¾¹æ¡† */
          .entity-list-table .entity-row-new {
            border-left: 4px solid var(--semi-color-primary) !important;
          }

          /* æ–°å¢å±æ€§è¡Œçš„å·¦è¾¹æ¡† */
          .entity-list-table .attribute-row-new {
            border-left: 4px solid var(--semi-color-primary) !important;
          }

          /* æ–°å¢å…ƒç´ çš„æ³›å…‰åŠ¨ç”» */
          @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
          }
        `}
      </style>

      {/* æ¨¡å—å…³è”å¼¹çª— */}
      {showModuleLinkModal && selectedEntity && (
        <ModuleSelectorTableModal
          visible={showModuleLinkModal}
          selectedModuleIds={selectedEntity.bundles || []}
          onCancel={() => {
            setShowModuleLinkModal(false);
            setSelectedEntity(null);
          }}
          onConfirm={handleSaveModuleLink}
          entityId={selectedEntity._indexId}
        />
      )}
    </div>
  );
};
